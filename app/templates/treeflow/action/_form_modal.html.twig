{% extends '_base_modal.html.twig' %}

{# Configure modal appearance and behavior #}
{% set entity_type = 'action' %}
{% set icon = 'action-circle' %}
{% set form_action = (is_edit and action.id) ? path('action_edit', {treeflowId: treeFlow.id.toRfc4122(), stepId: step.id.toRfc4122(), actionId: action.id.toRfc4122()}) : path('action_new', {treeflowId: treeFlow.id.toRfc4122(), stepId: step.id.toRfc4122()}) %}
{% set title_create = 'action.modal.create.title' %}
{% set subtitle_create = 'action.modal.create.subtitle' %}
{% set subtitle_edit = 'action.modal.edit.subtitle' %}
{% set subtitle_domain = 'treeflow' %}
{% set submit_key = is_edit ? 'button.save.changes' : 'action.button.create.action' %}
{% set submit_domain = is_edit ? 'messages' : 'treeflow' %}
{% set entity = action %}

{# Form fields #}
{% block modal_body %}
    <div class="form-group-modern">
        <label class="form-label-modern">{{ form_label(form.name) }}</label>
        {{ form_widget(form.name, {
            'attr': {
                'class': 'form-input-modern' ~ (form.name.vars.errors|length > 0 ? ' input-error' : ''),
                'placeholder': 'action.form.name.placeholder'|trans({}, 'treeflow'),
                'autofocus': 'autofocus'
            }
        }) }}
        {{ form_errors(form.name) }}
    </div>

    <div class="form-group-modern">
        <label class="form-label-modern">{{ form_label(form.prompt) }}</label>
        {{ form_widget(form.prompt, {
            'attr': {
                'class': 'form-input-modern' ~ (form.prompt.vars.errors|length > 0 ? ' input-error' : ''),
                'placeholder': 'action.form.prompt.placeholder'|trans({}, 'treeflow'),
                'rows': 4
            }
        }) }}
        {{ form_errors(form.prompt) }}
    </div>

    <div class="form-group-modern">
        <label class="form-label-modern">{{ form_label(form.importance) }}</label>
        <div class="star-rating-container" data-controller="star-rating">
            <!-- Hidden radio inputs (without labels) -->
            <div style="display: none;">
                {% for choice in form.importance %}
                    {{ form_widget(choice, {
                        'label': false,
                        'attr': {
                            'data-star-value': choice.vars.label,
                            'data-star-rating-target': 'input'
                        }
                    }) }}
                {% endfor %}
            </div>

            <!-- Visible clickable stars -->
            <div class="clickable-stars">
                <i class="bi bi-star-fill clickable-star" data-star="1"
                   data-star-rating-target="star"
                   data-action="click->star-rating#clickStar mouseenter->star-rating#hoverStar mouseleave->star-rating#leaveStar"></i>
                <i class="bi bi-star-fill clickable-star" data-star="2"
                   data-star-rating-target="star"
                   data-action="click->star-rating#clickStar mouseenter->star-rating#hoverStar mouseleave->star-rating#leaveStar"></i>
                <i class="bi bi-star-fill clickable-star" data-star="3"
                   data-star-rating-target="star"
                   data-action="click->star-rating#clickStar mouseenter->star-rating#hoverStar mouseleave->star-rating#leaveStar"></i>
            </div>
        </div>
        <small class="text-muted mt-1 d-block">{{ 'action.form.importance.help'|trans({}, 'treeflow') }}</small>
        {{ form_errors(form.importance) }}
    </div>

    <div class="form-group-modern">
        <label class="form-label-modern">{{ form_label(form.viewOrder) }}</label>
        {{ form_widget(form.viewOrder, {
            'attr': {
                'class': 'form-input-modern' ~ (form.viewOrder.vars.errors|length > 0 ? ' input-error' : ''),
                'placeholder': 'action.form.vieworder.placeholder'|trans({}, 'treeflow')
            }
        }) }}
        <small class="text-muted mt-1 d-block">{{ 'action.form.vieworder.help'|trans({}, 'treeflow') }}</small>
        {{ form_errors(form.viewOrder) }}
    </div>

    {# Few-Shot Examples #}
    <div class="form-group-modern">
        <label class="form-label-modern">{{ form_label(form.fewShot) }}</label>
        <small class="text-muted d-block mb-3">{{ 'action.form.fewshot.help'|trans({}, 'treeflow') }}</small>

        <div data-controller="collection" data-collection-prototype-name-value="{{ form.fewShot.vars.prototype.vars.name }}">
            <div data-prototype="{{ form_widget(form.fewShot.vars.prototype)|e('html_attr') }}">
                {% for exampleForm in form.fewShot %}
                    <div class="fewshot-item mb-3 p-3 border rounded" data-collection-target="item" data-index="{{ loop.index0 }}">
                        <div class="row">
                            <div class="col-12 mb-2">
                                <label class="form-label fw-bold text-primary">
                                    <i class="bi bi-person"></i> {{ form_label(exampleForm.user) }}
                                </label>
                                {{ form_widget(exampleForm.user) }}
                                {{ form_errors(exampleForm.user) }}
                            </div>
                            <div class="col-12 mb-2">
                                <label class="form-label fw-bold text-success">
                                    <i class="bi bi-robot"></i> {{ form_label(exampleForm.assistant) }}
                                </label>
                                {{ form_widget(exampleForm.assistant) }}
                                {{ form_errors(exampleForm.assistant) }}
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-danger mt-2" data-action="click->collection#removeItem">
                            <i class="bi bi-trash"></i> Remove Example
                        </button>
                    </div>
                {% endfor %}
            </div>

            <button type="button" class="btn btn-sm infinity-btn-primary add-item-btn" data-action="click->collection#addItem">
                <i class="bi bi-plus-circle"></i> Add Example
            </button>
        </div>

        <small class="text-muted d-block mt-2">
            <i class="bi bi-info-circle"></i> Add conversation examples to guide the AI's responses
        </small>
        {{ form_errors(form.fewShot) }}
    </div>

    {{ form_widget(form._token) }}

    {% if is_edit and action.id %}
        <div class="form-group-modern mt-4 pt-3 border-top">
            <button type="button" class="btn btn-sm btn-danger delete-trigger-btn" data-entity-type="action">
                <i class="bi bi-trash"></i> {{ 'button.delete'|trans }}
            </button>
        </div>
    {% endif %}
{% endblock %}

{% block modal_footer %}
    <div class="modal-footer-actions" id="modal-default-actions-action">
        {{ button_modal_cancel() }}
        {{ button_modal_submit(is_edit, submit_key|default(null), submit_domain|default('messages')) }}
    </div>

    {% if is_edit and action.id %}
        <div class="modal-footer-actions" id="modal-delete-confirmation-action" style="display: none;">
            <div class="text-danger fw-bold">{{ 'confirm.delete.entity'|trans }}</div>
            <button type="button" class="btn btn-sm btn-secondary delete-cancel-btn" data-entity-type="action">
                <i class="bi bi-x-circle"></i> {{ 'button.cancel'|trans }}
            </button>
            <button type="button" class="btn btn-sm btn-danger delete-confirm-btn"
                    data-entity-type="action"
                    data-delete-url="{{ path('action_delete', {treeflowId: treeFlow.id.toRfc4122(), stepId: step.id.toRfc4122(), actionId: action.id.toRfc4122()}) }}"
                    data-csrf-token="{{ csrf_token('delete-action-' ~ action.id.toRfc4122()) }}">
                <i class="bi bi-trash"></i> {{ 'button.confirm'|trans }}
            </button>
        </div>
    {% endif %}
{% endblock %}
