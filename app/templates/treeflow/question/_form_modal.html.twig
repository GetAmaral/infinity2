{% extends '_base_modal.html.twig' %}

{# Configure modal appearance and behavior #}
{% set entity_type = 'question' %}
{% set icon = 'question-circle' %}
{% set form_action = (is_edit and question.id) ? path('question_edit', {treeflowId: treeflow.id, stepId: step.id, questionId: question.id}) : path('question_new', {treeflowId: treeflow.id, stepId: step.id}) %}
{% set title_create = 'question.modal.create.title' %}
{% set subtitle_create = 'question.modal.create.subtitle' %}
{% set subtitle_edit = 'question.modal.edit.subtitle' %}
{% set subtitle_domain = 'treeflow' %}
{% set submit_key = is_edit ? 'button.save.changes' : 'question.button.create.question' %}
{% set submit_domain = is_edit ? 'messages' : 'treeflow' %}
{% set entity = question %}

{# Form fields #}
{% block modal_body %}
    <div class="form-group-modern">
        <label class="form-label-modern">{{ form_label(form.name) }}</label>
        {{ form_widget(form.name, {
            'attr': {
                'class': 'form-input-modern' ~ (form.name.vars.errors|length > 0 ? ' input-error' : ''),
                'placeholder': 'question.form.name.placeholder'|trans({}, 'treeflow'),
                'autofocus': 'autofocus'
            }
        }) }}
        {{ form_errors(form.name) }}
    </div>

    <div class="form-group-modern">
        <label class="form-label-modern">{{ form_label(form.prompt) }}</label>
        {{ form_widget(form.prompt, {
            'attr': {
                'class': 'form-input-modern' ~ (form.prompt.vars.errors|length > 0 ? ' input-error' : ''),
                'placeholder': 'question.form.prompt.placeholder'|trans({}, 'treeflow'),
                'rows': 4
            }
        }) }}
        {{ form_errors(form.prompt) }}
    </div>

    <div class="form-group-modern">
        <label class="form-label-modern">{{ form_label(form.objective) }}</label>
        {{ form_widget(form.objective, {
            'attr': {
                'class': 'form-input-modern' ~ (form.objective.vars.errors|length > 0 ? ' input-error' : ''),
                'placeholder': 'question.form.objective.placeholder'|trans({}, 'treeflow'),
                'rows': 3
            }
        }) }}
        {{ form_errors(form.objective) }}
    </div>

    <div class="form-group-modern">
        <label class="form-label-modern">{{ form_label(form.importance) }}</label>
        <div class="star-rating-container" data-controller="star-rating">
            <!-- Hidden radio inputs -->
            {% for choice in form.importance %}
                {{ form_widget(choice, {
                    'attr': {
                        'class': 'star-rating-input-hidden',
                        'data-star-value': choice.vars.label,
                        'data-star-rating-target': 'input'
                    }
                }) }}
            {% endfor %}

            <!-- Visible clickable stars -->
            <div class="clickable-stars">
                <i class="bi bi-star-fill clickable-star" data-star="1"
                   data-star-rating-target="star"
                   data-action="click->star-rating#clickStar mouseenter->star-rating#hoverStar mouseleave->star-rating#leaveStar"></i>
                <i class="bi bi-star-fill clickable-star" data-star="2"
                   data-star-rating-target="star"
                   data-action="click->star-rating#clickStar mouseenter->star-rating#hoverStar mouseleave->star-rating#leaveStar"></i>
                <i class="bi bi-star-fill clickable-star" data-star="3"
                   data-star-rating-target="star"
                   data-action="click->star-rating#clickStar mouseenter->star-rating#hoverStar mouseleave->star-rating#leaveStar"></i>
            </div>
        </div>
        <small class="text-muted mt-1 d-block">{{ 'question.form.importance.help'|trans({}, 'treeflow') }}</small>
        {{ form_errors(form.importance) }}
    </div>

    {# Positive Few-Shot Examples #}
    <div class="form-group-modern">
        <label class="form-label-modern">{{ form_label(form.fewShotPositive) }}</label>
        <small class="text-muted d-block mb-2">{{ 'question.form.fewshot.positive.help'|trans({}, 'treeflow') }}</small>
        <div class="fewshot-collection-container" data-collection="positive" data-index="{{ form.fewShotPositive|length }}" data-prototype="{{ form_widget(form.fewShotPositive.vars.prototype)|e('html_attr') }}">
            <div class="fewshot-items">
                {% for item in form.fewShotPositive %}
                    <div class="fewshot-item mb-2" style="position: relative;">
                        {{ form_widget(item, {'attr': {'class': 'form-input-modern fewshot-entry'}}) }}
                        <button type="button" class="fewshot-remove-btn-permanent"
                                title="{{ 'button.remove'|trans({}, 'messages') }}"
                                data-bs-toggle="tooltip">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                {% endfor %}
            </div>
            <button type="button" class="btn btn-sm luminai-btn-success fewshot-add mt-2"
                    title="{{ 'question.button.add.positive.example'|trans({}, 'treeflow') }}"
                    data-bs-toggle="tooltip">
                <i class="bi bi-plus-circle"></i>
            </button>
        </div>
        {{ form_errors(form.fewShotPositive) }}
    </div>

    {# Negative Few-Shot Examples #}
    <div class="form-group-modern">
        <label class="form-label-modern">{{ form_label(form.fewShotNegative) }}</label>
        <small class="text-muted d-block mb-2">{{ 'question.form.fewshot.negative.help'|trans({}, 'treeflow') }}</small>
        <div class="fewshot-collection-container" data-collection="negative" data-index="{{ form.fewShotNegative|length }}" data-prototype="{{ form_widget(form.fewShotNegative.vars.prototype)|e('html_attr') }}">
            <div class="fewshot-items">
                {% for item in form.fewShotNegative %}
                    <div class="fewshot-item mb-2" style="position: relative;">
                        {{ form_widget(item, {'attr': {'class': 'form-input-modern fewshot-entry'}}) }}
                        <button type="button" class="fewshot-remove-btn-permanent"
                                title="{{ 'button.remove'|trans({}, 'messages') }}"
                                data-bs-toggle="tooltip">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                {% endfor %}
            </div>
            <button type="button" class="btn btn-sm luminai-btn-success fewshot-add mt-2"
                    title="{{ 'question.button.add.negative.example'|trans({}, 'treeflow') }}"
                    data-bs-toggle="tooltip">
                <i class="bi bi-plus-circle"></i>
            </button>
        </div>
        {{ form_errors(form.fewShotNegative) }}
    </div>

    {{ form_widget(form._token) }}

    {% if is_edit and question.id %}
        <div class="form-group-modern mt-4 pt-3 border-top">
            <button type="button" class="btn btn-sm btn-danger delete-trigger-btn" data-entity-type="question">
                <i class="bi bi-trash"></i> {{ 'button.delete'|trans }}
            </button>
        </div>
    {% endif %}
{% endblock %}

{% block modal_footer %}
    <div class="modal-footer-actions" id="modal-default-actions-question">
        {{ button_modal_cancel() }}
        {{ button_modal_submit(is_edit, submit_key|default(null), submit_domain|default('messages')) }}
    </div>

    {% if is_edit and question.id %}
        <div class="modal-footer-actions" id="modal-delete-confirmation-question" style="display: none;">
            <div class="text-danger fw-bold">{{ 'confirm.delete.entity'|trans }}</div>
            <button type="button" class="btn btn-sm btn-secondary delete-cancel-btn" data-entity-type="question">
                <i class="bi bi-x-circle"></i> {{ 'button.cancel'|trans }}
            </button>
            <button type="button" class="btn btn-sm btn-danger delete-confirm-btn"
                    data-entity-type="question"
                    data-delete-url="{{ path('question_delete', {treeflowId: treeflow.id, stepId: step.id, questionId: question.id}) }}"
                    data-csrf-token="{{ csrf_token('delete-question-' ~ question.id) }}">
                <i class="bi bi-trash"></i> {{ 'button.confirm'|trans }}
            </button>
        </div>
    {% endif %}
{% endblock %}
