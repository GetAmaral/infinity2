{% extends 'base.html.twig' %}

{% block title %}{{ 'audit.entity.timeline.title'|trans({}, 'audit') }}{% endblock %}

{% block body %}
<div class="container-fluid py-4">
    <div class="luminai-card p-4 mb-4">
        <h1 class="text-gradient mb-0">
            <i class="bi bi-clock-history me-2"></i>{{ 'audit.entity.timeline.title'|trans({}, 'audit') }}
        </h1>

        <hr>

        <div class="row">
            <div class="col-md-6">
                <h6 class="text-muted mb-2">{{ 'audit.entity.type'|trans({}, 'audit') }}</h6>
                <p class="mb-0"><code>{{ entityClass }}</code></p>
            </div>
            <div class="col-md-6">
                <h6 class="text-muted mb-2">{{ 'audit.entity.id'|trans({}, 'audit') }}</h6>
                <p class="mb-0"><code>{{ entityId }}</code></p>
            </div>
        </div>
    </div>

    <div class="luminai-card p-4">
        <h5 class="mb-4">
            <i class="bi bi-list-timeline me-2"></i>{{ 'audit.complete.history'|trans({}, 'audit') }}
            <span class="badge bg-primary ms-2">{{ auditLogs|length }} {{ 'audit.event.count'|trans({}, 'audit') }}</span>
        </h5>

        {% if auditLogs is empty %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>{{ 'audit.no.history.available'|trans({}, 'audit') }}
            </div>
        {% else %}
            <div class="timeline">
                {% for log in auditLogs %}
                <div class="timeline-item mb-4">
                    <div class="d-flex">
                        <div class="timeline-marker me-3">
                            {% set iconClass = log.action == 'entity_created' ? 'plus-circle' : (log.action == 'entity_deleted' ? 'trash' : 'pencil-square') %}
                            {% set bgClass = log.action == 'entity_created' ? 'success' : (log.action == 'entity_deleted' ? 'danger' : 'primary') %}
                            <div class="rounded-circle bg-{{ bgClass }} p-2 d-inline-flex align-items-center justify-content-center"
                                 style="width: 40px; height: 40px;">
                                <i class="bi bi-{{ iconClass }} fs-5"></i>
                            </div>
                        </div>
                        <div class="timeline-content flex-grow-1 luminai-card p-3">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="text-white mb-0">
                                    {{ log.action|replace({'entity_': '', '_': ' '})|title }}
                                </h6>
                                <small class="text-muted">{{ log.createdAt|date('Y-m-d H:i:s') }}</small>
                            </div>

                            <p class="mb-2">
                                <i class="bi bi-person me-1"></i>
                                {{ 'audit.by'|trans({}, 'audit') }} {% if log.user %}
                                    <a href="{{ path('admin_audit_user', {id: log.user.id}) }}">{{ log.user.email }}</a>
                                {% else %}
                                    <em>{{ 'audit.system'|trans({}, 'audit') }}</em>
                                {% endif %}
                            </p>

                            {% if log.changes is not empty %}
                            <div class="changes-detail mt-3">
                                <h6 class="text-muted mb-2"><i class="bi bi-pencil-square me-1"></i>{{ 'audit.changes.label'|trans({}, 'audit') }}</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered">
                                        <thead>
                                            <tr>
                                                <th style="width: 30%;">{{ 'audit.field'|trans({}, 'audit') }}</th>
                                                <th style="width: 35%;">{{ 'audit.old.value'|trans({}, 'audit') }}</th>
                                                <th style="width: 35%;">{{ 'audit.new.value'|trans({}, 'audit') }}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for field, values in log.changes %}
                                            <tr>
                                                <td><strong>{{ field }}</strong></td>
                                                <td>
                                                    <code class="text-danger">{{ values[0]|default('audit.value.null'|trans({}, 'audit'))|slice(0, 100) }}</code>
                                                </td>
                                                <td>
                                                    <code class="text-success">{{ values[1]|default('audit.value.null'|trans({}, 'audit'))|slice(0, 100) }}</code>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            {% endif %}

                            {% set metadata = log.metadata %}
                            {% if metadata %}
                            <div class="metadata-detail mt-3 pt-3 border-top">
                                <small class="text-muted d-block">
                                    {% if metadata.ip_address %}
                                        <i class="bi bi-globe me-1"></i>{{ 'audit.metadata.ip'|trans({}, 'audit') }} {{ metadata.ip_address }}
                                    {% endif %}
                                    {% if metadata.user_agent %}
                                        <br><i class="bi bi-info-circle me-1"></i>{{ metadata.user_agent|slice(0, 80) }}{{ 'misc.loading.ellipsis'|trans }}
                                    {% endif %}
                                </small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>
</div>

<style>
.timeline {
    position: relative;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 20px;
    top: 40px;
    bottom: 0;
    width: 2px;
    background: rgba(59, 130, 246, 0.3);
}

.timeline-item:last-child .timeline-content::after {
    display: none;
}
</style>
{% endblock %}
