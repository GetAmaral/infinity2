{% extends 'base.html.twig' %}

{% block title %}{{ 'audit.title'|trans }}{% endblock %}

{% block body %}
<div class="container-fluid py-4">
    {# Header with Live Indicator #}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="text-gradient mb-0">
                <i class="bi bi-shield-check me-2"></i>{{ 'audit.title'|trans }}
            </h1>
            <p class="text-muted mb-0 mt-1">
                <i class="bi bi-circle-fill text-success me-1" style="font-size: 0.5rem; animation: pulse 2s ease-in-out infinite;"></i>
                {{ 'audit.live_monitoring'|trans }} â€¢ {{ 'audit.last_updated'|trans }} <span id="lastUpdate">{{ "now"|date("H:i:s") }}</span>
            </p>
        </div>
        <div>
            <a href="{{ path('admin_audit_analytics') }}" class="btn btn-outline-light me-2">
                <i class="bi bi-graph-up me-1"></i>{{ 'nav.analytics'|trans }}
            </a>
            <div class="btn-group">
                <button type="button" class="btn infinity-btn-primary dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="bi bi-download me-1"></i>{{ 'audit.export'|trans }}
                </button>
                <ul class="dropdown-menu dropdown-menu-end" style="background-color: #1a1d29; border: 1px solid rgba(59, 130, 246, 0.3);">
                    <li><a class="dropdown-item" href="{{ path('admin_audit_export', app.request.query.all) }}">
                        <i class="bi bi-filetype-csv me-2"></i>{{ 'audit.export.csv'|trans }}
                    </a></li>
                    <li><a class="dropdown-item" href="{{ path('admin_audit_export', app.request.query.all|merge({format: 'json'})) }}">
                        <i class="bi bi-file-earmark-code me-2"></i>{{ 'audit.export.json'|trans }}
                    </a></li>
                    <li><hr class="dropdown-divider" style="border-color: rgba(255, 255, 255, 0.1);"></li>
                    <li><a class="dropdown-item text-muted disabled"><i class="bi bi-file-earmark-pdf me-2"></i>{{ 'audit.export.pdf'|trans }}</a></li>
                </ul>
            </div>
        </div>
    </div>

    {# Stats Dashboard #}
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="infinity-card p-3 h-100">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="rounded-circle p-3" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.2));">
                            <i class="bi bi-database-fill text-primary" style="font-size: 1.5rem;"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6 class="text-muted mb-1" style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">{{ 'audit.stats.total_events'|trans }}</h6>
                        <h3 class="text-gradient mb-0">{{ stats.total_events|number_format }}</h3>
                        <p class="text-muted mb-0" style="font-size: 0.75rem;">{{ 'audit.stats.all_time'|trans }}</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="infinity-card p-3 h-100">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="rounded-circle p-3" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(22, 163, 74, 0.2));">
                            <i class="bi bi-calendar-check-fill text-success" style="font-size: 1.5rem;"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6 class="text-muted mb-1" style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">{{ 'audit.stats.today'|trans }}</h6>
                        <h3 class="mb-0" style="color: #22c55e;">{{ stats.events_today|number_format }}</h3>
                        <p class="text-muted mb-0" style="font-size: 0.75rem;">{{ 'audit.stats.last_24_hours'|trans }}</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="infinity-card p-3 h-100">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="rounded-circle p-3" style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(147, 51, 234, 0.2));">
                            <i class="bi bi-calendar-week-fill" style="font-size: 1.5rem; color: #a855f7;"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6 class="text-muted mb-1" style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">{{ 'audit.stats.this_week'|trans }}</h6>
                        <h3 class="mb-0" style="color: #a855f7;">{{ stats.events_week|number_format }}</h3>
                        <p class="text-muted mb-0" style="font-size: 0.75rem;">{{ 'audit.stats.last_7_days'|trans }}</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="infinity-card p-3 h-100">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="rounded-circle p-3" style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.2));">
                            <i class="bi bi-clock-history text-warning" style="font-size: 1.5rem;"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6 class="text-muted mb-1" style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">{{ 'audit.stats.last_hour'|trans }}</h6>
                        <h3 class="mb-0 text-warning">{{ stats.events_hour|number_format }}</h3>
                        <p class="text-muted mb-0" style="font-size: 0.75rem;">{{ 'audit.stats.recent_activity'|trans }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Quick Insights #}
    <div class="row g-3 mb-4">
        <div class="col-md-6">
            <div class="infinity-card p-3 h-100">
                <h6 class="mb-3">
                    <i class="bi bi-pie-chart me-2"></i>{{ 'audit.activity_breakdown'|trans }}
                </h6>
                <div class="d-flex justify-content-around">
                    {% set totalActions = 0 %}
                    {% for action in actionBreakdown %}
                        {% set totalActions = totalActions + action.count %}
                    {% endfor %}
                    {% for action in actionBreakdown %}
                        {% set percentage = totalActions > 0 ? (action.count / totalActions * 100)|round : 0 %}
                        {% set colorClass = action.action == 'entity_created' ? 'success' : (action.action == 'entity_deleted' ? 'danger' : 'primary') %}
                        <div class="text-center">
                            <div class="mb-2">
                                <span class="badge bg-{{ colorClass }}" style="font-size: 1.25rem; padding: 0.5rem 1rem;">
                                    {{ percentage }}%
                                </span>
                            </div>
                            <p class="text-muted mb-0" style="font-size: 0.75rem;">
                                {{ action.action|replace({'entity_': '', '_': ' '})|title }}
                            </p>
                            <small class="text-muted">{{ action.count }} {{ 'audit.events'|trans }}</small>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="infinity-card p-3 h-100">
                <h6 class="mb-3">
                    <i class="bi bi-people me-2"></i>{{ 'audit.top_active_users'|trans }}
                </h6>
                {% if topUsers is empty %}
                    <p class="text-muted mb-0">{{ 'audit.no_user_activity'|trans }}</p>
                {% else %}
                    <div class="list-group list-group-flush">
                        {% for userRow in topUsers %}
                            <div class="list-group-item d-flex justify-content-between align-items-center bg-transparent border-0 px-0 py-2">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-person-circle me-2 text-primary"></i>
                                    <span>{{ userRow[0].email }}</span>
                                </div>
                                <span class="badge bg-primary rounded-pill">{{ userRow.action_count }}</span>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    {# Advanced Filters #}
    <div class="infinity-card p-4 mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">
                <i class="bi bi-funnel me-2"></i>{{ 'audit.filters_and_search'|trans }}
            </h5>
            <button type="button" class="btn btn-sm btn-outline-light" id="toggleFilters">
                <i class="bi bi-chevron-down"></i>
            </button>
        </div>

        <div id="filterSection">
            {# Quick Filter Chips #}
            <div class="mb-3">
                <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-sm btn-outline-primary quick-filter" data-filter="today">
                        <i class="bi bi-calendar-day me-1"></i>{{ 'audit.filter.today'|trans }}
                    </button>
                    <button class="btn btn-sm btn-outline-primary quick-filter" data-filter="week">
                        <i class="bi bi-calendar-week me-1"></i>{{ 'audit.filter.week'|trans }}
                    </button>
                    <button class="btn btn-sm btn-outline-success quick-filter" data-filter="created">
                        <i class="bi bi-plus-circle me-1"></i>{{ 'audit.filter.created'|trans }}
                    </button>
                    <button class="btn btn-sm btn-outline-warning quick-filter" data-filter="updated">
                        <i class="bi bi-pencil me-1"></i>{{ 'audit.filter.updated'|trans }}
                    </button>
                    <button class="btn btn-sm btn-outline-danger quick-filter" data-filter="deleted">
                        <i class="bi bi-trash me-1"></i>{{ 'audit.filter.deleted'|trans }}
                    </button>
                </div>
            </div>

            {# Advanced Filter Form #}
            {{ form_start(searchForm, {'attr': {'class': 'mb-0'}}) }}
                <div class="row g-3">
                    <div class="col-md-3">
                        {{ form_row(searchForm.entityClass, {'attr': {'class': 'form-select'}}) }}
                    </div>
                    <div class="col-md-2">
                        {{ form_row(searchForm.action, {'attr': {'class': 'form-select'}}) }}
                    </div>
                    <div class="col-md-3">
                        {{ form_row(searchForm.user, {'attr': {'class': 'form-select'}}) }}
                    </div>
                    <div class="col-md-2">
                        {{ form_row(searchForm.dateFrom, {'attr': {'class': 'form-control'}}) }}
                    </div>
                    <div class="col-md-2">
                        {{ form_row(searchForm.dateTo, {'attr': {'class': 'form-control'}}) }}
                    </div>
                </div>
                <div class="mt-3 d-flex justify-content-between">
                    <div>
                        <button type="submit" class="btn infinity-btn-primary">
                            <i class="bi bi-search me-1"></i>{{ 'audit.apply_filters'|trans }}
                        </button>
                        <a href="{{ path('admin_audit_index') }}" class="btn btn-outline-light">
                            <i class="bi bi-arrow-clockwise me-1"></i>{{ 'audit.reset'|trans }}
                        </a>
                    </div>
                    <div class="text-muted small">
                        <kbd>Ctrl</kbd> + <kbd>F</kbd> {{ 'audit.focus_search_shortcut'|trans }}
                    </div>
                </div>
            {{ form_end(searchForm) }}
        </div>
    </div>

    {# Activity Timeline #}
    <div class="infinity-card p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="mb-0">
                <i class="bi bi-activity me-2"></i>{{ 'audit.activity_timeline'|trans }}
                <span class="badge bg-primary ms-2">{{ totalCount }}</span>
            </h5>
            <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-light active" id="viewTimeline">
                    <i class="bi bi-list-ul"></i> {{ 'audit.view.timeline'|trans }}
                </button>
                <button type="button" class="btn btn-outline-light" id="viewTable">
                    <i class="bi bi-table"></i> {{ 'audit.view.table'|trans }}
                </button>
            </div>
        </div>

        {% if auditLogs is empty %}
            <div class="text-center py-5">
                <i class="bi bi-inbox" style="font-size: 4rem; color: rgba(255, 255, 255, 0.1);"></i>
                <h5 class="text-muted mt-3">{{ 'audit.no_events_found'|trans }}</h5>
                <p class="text-muted">{{ 'audit.no_events_description'|trans }}</p>
            </div>
        {% else %}
            {# Timeline View #}
            <div id="timelineView">
                <div class="audit-timeline">
                    {% for log in auditLogs %}
                        <div class="timeline-item" data-entry-id="{{ log.id }}">
                            <div class="timeline-marker {{ log.action == 'entity_created' ? 'bg-success' : (log.action == 'entity_deleted' ? 'bg-danger' : 'bg-primary') }}">
                                <i class="bi bi-{{ log.action == 'entity_created' ? 'plus-lg' : (log.action == 'entity_deleted' ? 'trash' : 'pencil') }}"></i>
                            </div>
                            <div class="timeline-content">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <span class="badge bg-{{ log.action == 'entity_created' ? 'success' : (log.action == 'entity_deleted' ? 'danger' : 'primary') }} me-2">
                                            {{ log.action|replace({'entity_': '', '_': ' '})|title }}
                                        </span>
                                        <strong>{{ log.entityClass|split('\\\\')|last }}</strong>
                                    </div>
                                    <small class="text-muted">
                                        {{ log.createdAt|date('M d, H:i:s') }}
                                    </small>
                                </div>

                                <div class="d-flex align-items-center gap-3 mb-2">
                                    {% if log.user %}
                                        <a href="{{ path('admin_audit_user', {id: log.user.id}) }}" class="text-decoration-none">
                                            <i class="bi bi-person-circle me-1"></i>
                                            <span>{{ log.user.email }}</span>
                                        </a>
                                    {% else %}
                                        <span class="text-muted">
                                            <i class="bi bi-robot me-1"></i>{{ 'audit.system'|trans }}
                                        </span>
                                    {% endif %}

                                    <span class="text-muted">
                                        <i class="bi bi-hash"></i>
                                        <span class="font-monospace" style="font-size: 0.85rem;">{{ log.entityId|slice(0, 12) }}</span>
                                    </span>
                                </div>

                                <div class="mt-2">
                                    {% if log.changes is not empty %}
                                        <button type="button"
                                                class="btn btn-sm infinity-btn-ai"
                                                data-bs-toggle="collapse"
                                                data-bs-target="#changes-{{ log.id }}">
                                            <i class="bi bi-eye me-1"></i>
                                            {{ 'audit.view_changes'|trans({'%count%': log.changes|length}) }}
                                        </button>
                                    {% endif %}
                                    <button type="button"
                                            class="btn btn-sm btn-outline-light {% if log.changes is empty %}infinity-btn-primary{% else %}ms-2{% endif %}"
                                            onclick="openHistoryModal('{{ log.entityClass|e('js') }}', '{{ log.entityId }}', '{{ log.entityClass|split('\\\\')|last }}')">
                                        <i class="bi bi-clock-history me-1"></i>{{ 'audit.full_history'|trans }}
                                    </button>
                                    <a href="{{ path('admin_audit_entity', {
                                        class: log.entityClass|url_encode,
                                        id: log.entityId
                                    }) }}" class="btn btn-sm btn-link text-muted ms-1" target="_blank" title="Open in new tab">
                                        <i class="bi bi-box-arrow-up-right"></i>
                                    </a>
                                </div>

                                {% if log.changes is not empty %}

                                    <div class="collapse mt-3" id="changes-{{ log.id }}">
                                        <div class="card" style="background-color: rgba(0, 0, 0, 0.2); border: 1px solid rgba(59, 130, 246, 0.2);">
                                            <div class="card-body p-3">
                                                <h6 class="mb-3">
                                                    <i class="bi bi-pencil-square me-2"></i>{{ 'audit.field_changes'|trans }}
                                                </h6>
                                                {% for field, values in log.changes %}
                                                    <div class="change-row mb-2 p-2 rounded" style="background-color: rgba(255, 255, 255, 0.02);">
                                                        <div class="d-flex justify-content-between align-items-start">
                                                            <div class="flex-grow-1">
                                                                <strong class="text-primary">{{ field }}</strong>
                                                                <div class="d-flex gap-2 mt-2 flex-wrap">
                                                                    {# Check if it's JSON diff format #}
                                                                    {% if values.status is defined %}
                                                                        {# JSON field with recursive diff #}
                                                                        <div class="flex-grow-1">
                                                                            <div class="json-diff p-2 rounded" style="background-color: rgba(0, 0, 0, 0.3); font-family: 'Courier New', monospace; font-size: 0.85rem;">
                                                                                {{ values|json_encode(constant('JSON_PRETTY_PRINT'))|raw }}
                                                                            </div>
                                                                        </div>
                                                                    {% else %}
                                                                        {# Regular field change #}
                                                                        <div class="diff-old">
                                                                            <small class="text-muted d-block">{{ 'audit.old_value'|trans }}</small>
                                                                            <code class="text-danger">{{ values[0]|default('NULL') }}</code>
                                                                        </div>
                                                                        <div class="align-self-center">
                                                                            <i class="bi bi-arrow-right text-muted"></i>
                                                                        </div>
                                                                        <div class="diff-new">
                                                                            <small class="text-muted d-block">{{ 'audit.new_value'|trans }}</small>
                                                                            <code class="text-success">{{ values[1]|default('NULL') }}</code>
                                                                        </div>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endfor %}

                                                {# Metadata #}
                                                {% set metadata = log.metadata %}
                                                {% if metadata %}
                                                    <hr style="border-color: rgba(255, 255, 255, 0.1);">
                                                    <h6 class="mb-2"><i class="bi bi-info-circle me-2"></i>{{ 'audit.context'|trans }}</h6>
                                                    <div class="row g-2">
                                                        {% if metadata.ip_address %}
                                                            <div class="col-md-6">
                                                                <small class="text-muted">{{ 'audit.ip_address'|trans }}:</small>
                                                                <div><code class="text-info">{{ metadata.ip_address }}</code></div>
                                                            </div>
                                                        {% endif %}
                                                        {% if metadata.user_agent %}
                                                            <div class="col-md-6">
                                                                <small class="text-muted">{{ 'audit.user_agent'|trans }}:</small>
                                                                <div class="text-truncate small">{{ metadata.user_agent }}</div>
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>

            {# Table View (Hidden by default) #}
            <div id="tableView" style="display: none;">
                <div class="table-responsive">
                    <table class="table table-hover align-middle audit-table">
                        <thead>
                            <tr>
                                <th class="text-nowrap"><i class="bi bi-clock me-1"></i>{{ 'audit.table.timestamp'|trans }}</th>
                                <th class="text-nowrap"><i class="bi bi-lightning me-1"></i>{{ 'audit.table.action'|trans }}</th>
                                <th class="text-nowrap"><i class="bi bi-box me-1"></i>{{ 'audit.table.entity'|trans }}</th>
                                <th class="text-nowrap d-none d-md-table-cell"><i class="bi bi-person me-1"></i>{{ 'audit.table.user'|trans }}</th>
                                <th class="text-nowrap text-center"><i class="bi bi-pencil-square me-1"></i>{{ 'audit.table.changes'|trans }}</th>
                                <th class="text-nowrap text-center"><i class="bi bi-gear me-1"></i>{{ 'audit.table.actions'|trans }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in auditLogs %}
                            <tr>
                                <td>
                                    <small class="text-muted">{{ log.createdAt|date('Y-m-d') }}</small><br>
                                    <strong>{{ log.createdAt|date('H:i:s') }}</strong>
                                </td>
                                <td>
                                    <span class="badge bg-{{ log.action == 'entity_created' ? 'success' : (log.action == 'entity_deleted' ? 'danger' : 'primary') }}">
                                        <i class="bi bi-{{ log.action == 'entity_created' ? 'plus-circle' : (log.action == 'entity_deleted' ? 'trash' : 'pencil') }} me-1"></i>
                                        {{ log.action|replace({'entity_': '', '_': ' '})|title }}
                                    </span>
                                </td>
                                <td>
                                    <div><strong>{{ log.entityClass|split('\\\\')|last }}</strong></div>
                                    <small class="text-muted font-monospace">{{ log.entityId|slice(0, 8) }}...</small>
                                </td>
                                <td class="d-none d-md-table-cell">
                                    {% if log.user %}
                                        <a href="{{ path('admin_audit_user', {id: log.user.id}) }}" class="text-decoration-none">
                                            <i class="bi bi-person-circle me-1"></i>{{ log.user.email }}
                                        </a>
                                    {% else %}
                                        <em class="text-muted"><i class="bi bi-robot me-1"></i>{{ 'audit.system'|trans }}</em>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if log.changes is not empty %}
                                        <span class="badge bg-info">{{ log.changes|length }}</span>
                                    {% else %}
                                        <span class="text-muted">â€”</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <button type="button"
                                            class="btn btn-sm btn-outline-light"
                                            onclick="openHistoryModal('{{ log.entityClass|e('js') }}', '{{ log.entityId }}', '{{ log.entityClass|split('\\\\')|last }}')"
                                            title="View history">
                                        <i class="bi bi-clock-history"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% endif %}

        {# Pagination #}
        {% if totalPages > 1 %}
        <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top" style="border-color: rgba(255, 255, 255, 0.1) !important;">
            <div class="text-muted">
                {{ 'audit.showing'|trans }} {{ ((currentPage - 1) * itemsPerPage + 1) }} {{ 'audit.to'|trans }} {{ min(currentPage * itemsPerPage, totalCount) }} {{ 'audit.of'|trans }} {{ totalCount|number_format }} {{ 'audit.events_total'|trans }}
            </div>
            <nav aria-label="Audit log pagination">
                <ul class="pagination pagination-sm mb-0">
                    {# Previous Button #}
                    <li class="page-item {% if currentPage <= 1 %}disabled{% endif %}">
                        <a class="page-link" href="{{ currentPage > 1 ? path('admin_audit_index', app.request.query.all|merge({page: currentPage - 1})) : '#' }}" {% if currentPage <= 1 %}tabindex="-1" aria-disabled="true"{% endif %}>
                            <i class="bi bi-chevron-left"></i> {{ 'audit.previous'|trans }}
                        </a>
                    </li>

                    {# Page Numbers with Smart Ellipsis #}
                    {% set showPages = [] %}
                    {% if totalPages <= 7 %}
                        {% for p in 1..totalPages %}
                            {% set showPages = showPages|merge([p]) %}
                        {% endfor %}
                    {% else %}
                        {# Always show first page #}
                        {% set showPages = showPages|merge([1]) %}

                        {# Show pages around current page #}
                        {% if currentPage > 3 %}
                            {% set showPages = showPages|merge(['...']) %}
                        {% endif %}

                        {% for p in max(2, currentPage - 1)..min(totalPages - 1, currentPage + 1) %}
                            {% set showPages = showPages|merge([p]) %}
                        {% endfor %}

                        {# Always show last page #}
                        {% if currentPage < totalPages - 2 %}
                            {% set showPages = showPages|merge(['...']) %}
                        {% endif %}
                        {% set showPages = showPages|merge([totalPages]) %}
                    {% endif %}

                    {% for pageNum in showPages %}
                        {% if pageNum == '...' %}
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        {% else %}
                            <li class="page-item {% if pageNum == currentPage %}active{% endif %}">
                                <a class="page-link" href="{{ path('admin_audit_index', app.request.query.all|merge({page: pageNum})) }}">
                                    {{ pageNum }}
                                </a>
                            </li>
                        {% endif %}
                    {% endfor %}

                    {# Next Button #}
                    <li class="page-item {% if currentPage >= totalPages %}disabled{% endif %}">
                        <a class="page-link" href="{{ currentPage < totalPages ? path('admin_audit_index', app.request.query.all|merge({page: currentPage + 1})) : '#' }}" {% if currentPage >= totalPages %}tabindex="-1" aria-disabled="true"{% endif %}>
                            {{ 'audit.next'|trans }} <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>

    {# History Modal #}
    <div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content audit-history-modal">
                <div class="modal-header">
                    <h5 class="modal-title" id="historyModalLabel">
                        <i class="bi bi-clock-history me-2"></i>{{ 'audit.history_modal.title'|trans }}
                    </h5>
                    <button type="button" class="btn-close audit-modal-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="historyModalBody">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">{{ 'audit.history_modal.loading'|trans }}</span>
                        </div>
                        <p class="text-muted mt-3">{{ 'audit.history_modal.loading_description'|trans }}</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <a id="historyOpenNewTab" href="#" target="_blank" class="btn btn-outline-light">
                        <i class="bi bi-box-arrow-up-right me-1"></i>{{ 'audit.history_modal.open_new_tab'|trans }}
                    </a>
                    <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">{{ 'audit.history_modal.close'|trans }}</button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Timeline Styles */
.audit-timeline {
    position: relative;
    padding-left: 40px;
}

.audit-timeline::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: linear-gradient(to bottom, rgba(59, 130, 246, 0.5), rgba(59, 130, 246, 0.1));
}

.timeline-item {
    position: relative;
    margin-bottom: 2rem;
}

.timeline-marker {
    position: absolute;
    left: -32px;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 3px solid #1a1d29;
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    z-index: 1;
}

.timeline-content {
    background-color: rgba(255, 255, 255, 0.02);
    border: 1px solid rgba(59, 130, 246, 0.2);
    border-radius: 8px;
    padding: 1rem;
    transition: all 0.3s ease;
}

.timeline-content:hover {
    border-color: rgba(59, 130, 246, 0.5);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
    transform: translateX(2px);
}

/* Pulse animation for live indicator */
@keyframes pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.3;
    }
}

/* Quick filter pills */
.quick-filter {
    transition: all 0.2s ease;
}

.quick-filter:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(59, 130, 246, 0.2);
}

/* Enhanced code blocks */
code {
    padding: 2px 6px;
    border-radius: 4px;
    background-color: rgba(0, 0, 0, 0.3);
}

.json-diff {
    max-height: 300px;
    overflow-y: auto;
    white-space: pre-wrap;
    word-wrap: break-word;
}

/* Modal enhancements */
.modal-xl {
    max-width: 1200px;
}

#historyModal .modal-body {
    max-height: calc(100vh - 200px);
    overflow-y: auto;
}

#historyModal .audit-timeline {
    padding-left: 30px;
}

#historyModal .timeline-marker {
    left: -27px;
    width: 28px;
    height: 28px;
}

/* History Modal Theme Support - Dark Theme (Default) */
.audit-history-modal {
    background-color: #1a1d29 !important;
    border: 1px solid rgba(59, 130, 246, 0.3) !important;
    color: rgba(255, 255, 255, 0.9);
}

.audit-history-modal .modal-header {
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.audit-history-modal .modal-footer {
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.audit-modal-close {
    filter: invert(1) grayscale(100%) brightness(200%);
}

/* History Modal Theme Support - Light Theme */
[data-theme="light"] .audit-history-modal {
    background-color: #ffffff !important;
    border: 1px solid rgba(0, 0, 0, 0.1) !important;
    color: #1a1a1a;
}

[data-theme="light"] .audit-history-modal .modal-header {
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

[data-theme="light"] .audit-history-modal .modal-footer {
    border-top: 1px solid rgba(0, 0, 0, 0.1);
}

[data-theme="light"] .audit-modal-close {
    filter: none;
}

/* Table Styles - Dark Theme (Default) */
.audit-table {
    background-color: rgba(255, 255, 255, 0.02) !important;
    border-radius: 8px;
    overflow: hidden;
    --bs-table-bg: transparent !important;
    --bs-table-striped-bg: transparent !important;
}

.audit-table thead {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(37, 99, 235, 0.15)) !important;
    border-bottom: 2px solid rgba(59, 130, 246, 0.3);
}

.audit-table thead th {
    font-weight: 600;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 1rem 0.75rem;
    border: none;
    color: rgba(255, 255, 255, 0.9);
    background-color: transparent !important;
}

.audit-table tbody tr {
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    transition: all 0.2s ease;
    background-color: transparent !important;
}

.audit-table tbody tr:hover {
    background-color: rgba(59, 130, 246, 0.08) !important;
    transform: scale(1.01);
}

.audit-table tbody td {
    padding: 0.875rem 0.75rem;
    vertical-align: middle;
    border: none;
    color: rgba(255, 255, 255, 0.9);
    background-color: transparent !important;
}

.table-responsive {
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    background-color: transparent;
}

/* Table Styles - Light Theme */
[data-theme="light"] .audit-table {
    background-color: rgba(255, 255, 255, 0.9) !important;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    --bs-table-bg: rgba(255, 255, 255, 0.9) !important;
    --bs-table-striped-bg: rgba(0, 0, 0, 0.02) !important;
}

[data-theme="light"] .audit-table thead {
    background: linear-gradient(135deg, rgba(79, 70, 229, 0.08), rgba(124, 58, 237, 0.08)) !important;
    border-bottom: 2px solid rgba(79, 70, 229, 0.2);
}

[data-theme="light"] .audit-table thead th {
    color: #1a1a1a;
    background-color: transparent !important;
}

[data-theme="light"] .audit-table tbody tr {
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    background-color: transparent !important;
}

[data-theme="light"] .audit-table tbody tr:hover {
    background-color: rgba(79, 70, 229, 0.05) !important;
}

[data-theme="light"] .audit-table tbody td {
    color: #1a1a1a;
    background-color: transparent !important;
}

[data-theme="light"] .table-responsive {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    background-color: rgba(255, 255, 255, 0.5);
}

/* Table text elements - theme aware */
.audit-table .text-muted {
    color: rgba(255, 255, 255, 0.5) !important;
}

[data-theme="light"] .audit-table .text-muted {
    color: rgba(0, 0, 0, 0.5) !important;
}

.audit-table code {
    background-color: rgba(0, 0, 0, 0.3);
    color: rgba(255, 255, 255, 0.9);
}

[data-theme="light"] .audit-table code {
    background-color: rgba(0, 0, 0, 0.05);
    color: #1a1a1a;
}

.audit-table a {
    color: #60a5fa;
    text-decoration: none;
}

.audit-table a:hover {
    color: #93c5fd;
}

[data-theme="light"] .audit-table a {
    color: #2563eb;
}

[data-theme="light"] .audit-table a:hover {
    color: #1d4ed8;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .audit-timeline {
        padding-left: 25px;
    }

    .timeline-marker {
        left: -25px;
        width: 24px;
        height: 24px;
        font-size: 0.75rem;
    }

    .timeline-content {
        padding: 0.75rem;
    }

    .modal-xl {
        max-width: 95%;
    }

    /* Table responsive adjustments */
    .audit-table thead th {
        font-size: 0.75rem;
        padding: 0.75rem 0.5rem;
    }

    .audit-table tbody td {
        padding: 0.75rem 0.5rem;
        font-size: 0.875rem;
    }

    .audit-table tbody td small {
        font-size: 0.75rem;
    }

    /* Stack timestamp on mobile */
    .audit-table tbody td:first-child {
        min-width: 80px;
    }
}

@media (max-width: 576px) {
    .table-responsive {
        border-radius: 4px;
    }

    .audit-table thead th,
    .audit-table tbody td {
        padding: 0.5rem 0.25rem;
    }

    .audit-table .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }
}
</style>

<script>
// Open history in modal (preserves scroll position)
function openHistoryModal(entityClass, entityId, entityName) {
    const modal = new bootstrap.Modal(document.getElementById('historyModal'));
    const modalBody = document.getElementById('historyModalBody');
    const modalTitle = document.getElementById('historyModalLabel');
    const openNewTabBtn = document.getElementById('historyOpenNewTab');

    // Update modal title
    modalTitle.innerHTML = `<i class="bi bi-clock-history me-2"></i>{{ 'audit.history_modal.history'|trans }} ${entityName} <code class="ms-2" style="font-size: 0.75rem;">${entityId.substring(0, 8)}...</code>`;

    // Update "Open in New Tab" link
    const url = `/admin/audit/entity/${encodeURIComponent(entityClass)}/${entityId}`;
    openNewTabBtn.href = url;

    // Show loading state
    modalBody.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-muted mt-3">Loading history...</p>
        </div>
    `;

    // Open modal
    modal.show();

    // Fetch history via AJAX
    fetch(url, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.text();
    })
    .then(html => {
        // Extract the timeline content from the response
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const content = doc.querySelector('.audit-timeline') || doc.querySelector('.container-fluid');

        if (content) {
            modalBody.innerHTML = content.outerHTML;
        } else {
            modalBody.innerHTML = html;
        }
    })
    .catch(error => {
        console.error('Error loading history:', error);
        modalBody.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>
                {{ 'audit.history_modal.failed'|trans }} <a href="${url}" target="_blank">{{ 'audit.history_modal.open_link'|trans }}</a>.
            </div>
        `;
    });
}

// Use event delegation to avoid re-attaching listeners on Turbo navigation
// Toggle filters - event delegation
document.addEventListener('click', function(e) {
    const toggleBtn = e.target.closest('#toggleFilters');
    if (toggleBtn) {
        const filterSection = document.getElementById('filterSection');
        if (filterSection) {
            filterSection.classList.toggle('d-none');
            const icon = toggleBtn.querySelector('i');
            if (icon) {
                icon.classList.toggle('bi-chevron-down');
                icon.classList.toggle('bi-chevron-up');
            }
        }
    }

    // View toggle - Timeline
    const viewTimelineBtn = e.target.closest('#viewTimeline');
    if (viewTimelineBtn) {
        const timelineView = document.getElementById('timelineView');
        const tableView = document.getElementById('tableView');
        const viewTable = document.getElementById('viewTable');

        if (timelineView && tableView) {
            timelineView.style.display = 'block';
            tableView.style.display = 'none';
            viewTimelineBtn.classList.add('active');
            if (viewTable) viewTable.classList.remove('active');
        }
    }

    // View toggle - Table
    const viewTableBtn = e.target.closest('#viewTable');
    if (viewTableBtn) {
        const timelineView = document.getElementById('timelineView');
        const tableView = document.getElementById('tableView');
        const viewTimeline = document.getElementById('viewTimeline');

        if (timelineView && tableView) {
            timelineView.style.display = 'none';
            tableView.style.display = 'block';
            viewTableBtn.classList.add('active');
            if (viewTimeline) viewTimeline.classList.remove('active');
        }
    }
});

// Keep the old DOMContentLoaded for other functionality
document.addEventListener('DOMContentLoaded', function() {

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl+F to focus first filter
        if (e.ctrlKey && e.key === 'f') {
            e.preventDefault();
            const firstInput = document.querySelector('#filterSection select, #filterSection input');
            if (firstInput) firstInput.focus();
        }
    });

    // Update last updated time
    setInterval(function() {
        const now = new Date();
        const timeStr = now.getHours().toString().padStart(2, '0') + ':' +
                       now.getMinutes().toString().padStart(2, '0') + ':' +
                       now.getSeconds().toString().padStart(2, '0');
        const lastUpdate = document.getElementById('lastUpdate');
        if (lastUpdate) {
            lastUpdate.textContent = timeStr;
        }
    }, 1000);
});
</script>
{% endblock %}
