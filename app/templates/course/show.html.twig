{% extends 'base.html.twig' %}
{% import '_macros/organization_logo.html.twig' as org_logo %}

{% block title %}{{ course.name }} - {{ 'course.singular'|trans }} - {{ 'page.infinity.suffix'|trans }}{% endblock %}

{% block body %}
<!-- Navigation -->
<div class="mb-4">
    <a href="{{ path('course_index') }}" class="btn infinity-btn-ai">
        <i class="bi bi-arrow-left me-2"></i>{{ 'course.back.to.list'|trans }}
    </a>
</div>

<!-- Course Header -->
<div class="ai-dashboard-header mb-4">
    <div class="d-flex justify-content-between align-items-start">
        <div class="d-flex align-items-center">
            <div class="p-3 rounded-3 me-4" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                <i class="bi bi-book text-white fs-2"></i>
            </div>
            <div>
                <h1 class="text-gradient mb-2">{{ course.name }}</h1>
                {% if course.description %}
                    <p class="text-secondary mb-0 fs-5">{{ course.description }}</p>
                {% else %}
                    <p class="text-muted mb-0 fst-italic">{{ 'empty.no.description'|trans }}</p>
                {% endif %}
            </div>
        </div>
        <div class="d-flex gap-2">
            <div class="ai-status-indicator" style="{{ course.active ? 'background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(22, 163, 74, 0.15)); border-color: rgba(34, 197, 94, 0.3); color: #22c55e;' : 'background: rgba(156, 163, 175, 0.15); border-color: rgba(156, 163, 175, 0.3); color: #9ca3af;' }}">
                <i class="bi bi-{{ course.active ? 'check-circle-fill' : 'x-circle-fill' }}"></i> {{ course.active ? 'common.status.active'|trans : 'common.status.inactive'|trans }}
            </div>
            <div class="real-time-badge">
                {% set totalLectures = 0 %}
                {% for module in modules %}
                    {% set totalLectures = totalLectures + module.lectures|length %}
                {% endfor %}
                {{ modules|length }} {{ 'course.modules'|trans }} • {{ totalLectures }} {{ 'course.lectures'|trans }}
            </div>
            {% if is_granted('COURSE_EDIT', course) %}
                <button type="button"
                        class="btn infinity-btn-primary btn-sm"
                        data-controller="modal-opener"
                        data-modal-opener-url-value="{{ path('course_edit', {id: course.id}) }}"
                        data-action="click->modal-opener#open"
                        data-bs-toggle="tooltip"
                        data-bs-title="{{ 'button.edit'|trans }}">
                    <i class="bi bi-pencil"></i>
                </button>
            {% endif %}
            {% if is_granted('COURSE_DELETE', course) %}
                <button type="button"
                        class="btn infinity-btn-danger btn-sm"
                        data-delete-url="{{ path('course_delete', {id: course.id}) }}"
                        data-entity-name="{{ course.name }}"
                        data-csrf-token="{{ csrf_token('delete-course-' ~ course.id) }}"
                        data-bs-toggle="tooltip"
                        data-bs-title="{{ 'button.delete'|trans }}">
                    <i class="bi bi-trash"></i>
                </button>
            {% endif %}
        </div>
    </div>
</div>

<!-- Course Details Bento Grid -->
<div class="bento-grid">
    <!-- Quick Stats - Modules Count -->
    <div class="bento-item">
        <div class="metric-card">
            <i class="bi bi-layers-fill text-neon fs-1"></i>
            <div class="metric-value">{{ modules|length }}</div>
            <div class="metric-label">{{ 'course.total.modules'|trans }}</div>
            <div class="metric-trend trend-up">
                <i class="bi bi-arrow-up"></i> {{ course.active ? 'common.status.active'|trans : 'common.status.inactive'|trans }}
            </div>
        </div>
    </div>

    <!-- Quick Stats - Total Duration -->
    <div class="bento-item">
        <div class="metric-card">
            <i class="bi bi-clock-fill text-neon fs-1"></i>
            <div class="metric-value">{{ course.totalLengthFormatted }}</div>
            <div class="metric-label">{{ 'course.total.duration'|trans }}</div>
            <div class="metric-trend">
                <i class="bi bi-calendar me-1"></i> {{ course.releaseDate ? course.releaseDate|date('M d, Y') : 'course.no.release.date'|trans }}
            </div>
        </div>
    </div>

    <!-- Course Information -->
    <div class="bento-item">
        <div class="infinity-card ai-enhanced p-4 h-100">
            <div class="d-flex align-items-center mb-3">
                <i class="bi bi-info-circle text-neon me-2"></i>
                <h6 class="text-gradient mb-0">{{ 'course.information'|trans }}</h6>
            </div>
            <div class="text-secondary">
                <p class="mb-2">
                    <i class="bi bi-person text-success me-2"></i>
                    <strong>{{ 'course.owner'|trans }}:</strong> {{ course.owner.name }}
                </p>
                <p class="mb-2 d-flex align-items-center">
                    {{ org_logo.logo(course.organization, 'xs', 'me-2') }}
                    <strong>{{ 'organization.singular'|trans }}:</strong>
                    <span class="ms-1">{{ course.organization.name }}</span>
                </p>
                <p class="mb-0">
                    <i class="bi bi-calendar-check text-info me-2"></i>
                    <strong>{{ 'course.created.at'|trans }}:</strong> {{ course.createdAt|date('M d, Y') }}
                </p>
            </div>
        </div>
    </div>

    <!-- Modules & Lectures Section -->
    <div class="bento-item large"
         data-controller="module-lecture-reorder"
         data-module-lecture-reorder-update-url-value="{{ path('course_lectures_reorder', {id: course.id}) }}"
         data-module-lecture-reorder-course-id-value="{{ course.id }}"
         data-module-lecture-reorder-saving-text-value="{{ 'button.saving'|trans }}"
         data-module-lecture-reorder-success-text-value="{{ 'course.lecture.flash.updated_successfully'|trans }}"
         data-module-lecture-reorder-error-text-value="{{ 'modal.delete.failed'|trans }}">
        <div class="infinity-card p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="text-neon mb-0">
                    <i class="bi bi-layers me-2"></i>{{ 'course.modules.and.lectures'|trans }} ({{ modules|length }} {{ 'course.modules'|trans }})
                </h5>
                {% if is_granted('COURSE_EDIT', course) %}
                    <button type="button"
                            class="btn infinity-btn-primary btn-sm"
                            data-controller="modal-opener"
                            data-modal-opener-url-value="{{ path('course_module_new', {courseId: course.id}) }}"
                            data-action="click->modal-opener#open"
                            data-bs-toggle="tooltip"
                            data-bs-title="{{ 'button.add.module'|trans }}">
                        <i class="bi bi-plus-circle"></i>
                    </button>
                {% endif %}
            </div>

            {% if modules is empty %}
                <div class="text-center py-5">
                    <i class="bi bi-layers" style="font-size: 3rem; color: var(--infinity-text-muted);"></i>
                    <h5 class="text-white mt-3 mb-2">{{ 'empty.no.modules.yet'|trans }}</h5>
                    <p class="text-secondary mb-4">{{ 'empty.course.modules.description'|trans }}</p>
                    {% if is_granted('COURSE_EDIT', course) %}
                        <button type="button"
                                class="btn infinity-btn-primary"
                                data-controller="modal-opener"
                                data-modal-opener-url-value="{{ path('course_module_new', {courseId: course.id}) }}"
                                data-action="click->modal-opener#open">
                            <i class="bi bi-plus-circle me-2"></i>{{ 'button.add.first.module'|trans }}
                        </button>
                    {% endif %}
                </div>
            {% else %}
                <div class="accordion"
                     id="modulesAccordion"
                     data-controller="module-reorder"
                     data-module-reorder-update-url-value="{{ path('course_modules_reorder', {courseId: course.id}) }}"
                     data-module-reorder-course-id-value="{{ course.id }}"
                     data-module-reorder-saving-text-value="{{ 'button.saving'|trans }}"
                     data-module-reorder-success-text-value="{{ 'course.module.flash.reordered_successfully'|trans }}"
                     data-module-reorder-error-text-value="{{ 'modal.delete.failed'|trans }}">
                    {% for module in modules %}
                        <div class="module-wrapper mb-3" data-module-id="{{ module.id }}" data-module-reorder-target="module">
                            <div class="accordion-item" style="background: var(--infinity-card-bg); border: 1px solid var(--infinity-border-color); border-radius: 8px; overflow: hidden;">
                                <h2 class="accordion-header d-flex align-items-center" id="heading-module-{{ module.id }}">
                                    {% if is_granted('COURSE_EDIT', course) %}
                                        <div class="module-drag-handle me-2" title="{{ 'course.module.drag.to.reorder'|trans }}">
                                            <i class="bi bi-grip-vertical"></i>
                                        </div>
                                    {% endif %}
                                    <button class="accordion-button flex-grow-1"
                                        type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#collapse-module-{{ module.id }}"
                                        aria-expanded="true"
                                        aria-controls="collapse-module-{{ module.id }}"
                                        style="background: var(--infinity-card-bg); color: white; border: none; padding: 1.25rem;">
                                    <div class="p-2 rounded-3 me-3 module-order-badge" style="background: linear-gradient(135deg, #f59e0b, #d97706); min-width: 48px; display: flex; align-items: center; justify-content: center;">
                                        <span class="text-white fw-bold">{{ module.viewOrder }}</span>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1 text-white">{{ module.name }}</h6>
                                        <small class="text-secondary module-header-summary" data-module-id="{{ module.id }}">
                                            <span class="module-header-lecture-count">{{ module.lectures|length }} {{ 'course.lectures'|trans }}</span>
                                            {% if module.totalLengthSeconds > 0 %}
                                                • <i class="bi bi-clock me-1"></i>{{ module.totalLengthFormatted }}
                                            {% endif %}
                                            {% if not module.active %}
                                                • <span class="badge bg-secondary">{{ 'common.status.inactive'|trans }}</span>
                                            {% endif %}
                                        </small>
                                    </div>
                                </button>
                                {% if is_granted('COURSE_EDIT', course) %}
                                    <div class="d-flex gap-1 me-3">
                                        <button type="button"
                                                class="btn btn-sm infinity-btn-ai"
                                                data-controller="modal-opener"
                                                data-modal-opener-url-value="{{ path('course_module_edit', {courseId: course.id, moduleId: module.id}) }}"
                                                data-action="click->modal-opener#open"
                                                data-bs-toggle="tooltip"
                                                data-bs-title="{{ 'button.edit'|trans }}"
                                                style="min-width: 32px;">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button type="button"
                                                class="btn btn-sm infinity-btn-danger"
                                                data-delete-url="{{ path('course_module_delete', {courseId: course.id, moduleId: module.id}) }}"
                                                data-entity-name="{{ module.name }}"
                                                data-csrf-token="{{ csrf_token('delete-module-' ~ module.id) }}"
                                                data-bs-toggle="tooltip"
                                                data-bs-title="{{ 'button.delete'|trans }}"
                                                style="min-width: 32px;">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                {% endif %}
                            </h2>
                            <div id="collapse-module-{{ module.id }}"
                                 class="accordion-collapse collapse show"
                                 aria-labelledby="heading-module-{{ module.id }}"
                                 data-bs-parent="#modulesAccordion">
                                <div class="accordion-body lectures-drop-zone"
                                     style="padding: 1.25rem; background: rgba(0, 0, 0, 0.2); min-height: 100px;"
                                     data-module-lecture-reorder-target="module"
                                     data-module-id="{{ module.id }}">
                                    {% if module.description %}
                                        <p class="text-secondary mb-3">{{ module.description }}</p>
                                    {% endif %}

                                    <!-- Lectures Header with Add Button -->
                                    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                                        <h6 class="text-white mb-0">
                                            <i class="bi bi-collection me-2"></i>{{ 'course.lectures'|trans }} (<span class="module-lecture-count" data-module-id="{{ module.id }}">{{ module.lectures|length }}</span>)
                                        </h6>
                                        {% if is_granted('COURSE_EDIT', course) %}
                                            <button type="button"
                                                    class="btn infinity-btn-primary btn-sm"
                                                    data-controller="modal-opener"
                                                    data-modal-opener-url-value="{{ path('course_module_lecture_new', {courseId: course.id, moduleId: module.id}) }}"
                                                    data-action="click->modal-opener#open"
                                                    data-bs-toggle="tooltip"
                                                    data-bs-title="{{ 'button.add.lecture'|trans }}">
                                                <i class="bi bi-plus-circle"></i>
                                            </button>
                                        {% endif %}
                                    </div>

                                    {% if module.lectures is empty %}
                                        <!-- Empty State -->
                                        <div class="module-empty-state infinity-card p-4 text-center" data-module-id="{{ module.id }}">
                                            <i class="bi bi-collection text-muted" style="font-size: 2.5rem;"></i>
                                            <p class="text-secondary mt-3 mb-0">{{ 'empty.no.lectures.in.module'|trans }}</p>
                                        </div>
                                    {% else %}
                                        <!-- Lectures List -->
                                        {% for lecture in module.lectures %}
                                            <div class="mb-3 lecture-card-wrapper" data-lecture-id="{{ lecture.id }}">
                                                <div class="infinity-card p-3 lecture-card">
                                                    <div class="d-flex align-items-start">
                                                        <!-- Drag Handle -->
                                                        <div class="lecture-drag-handle me-2" title="{{ 'course.lecture.drag.to.reorder'|trans }}">
                                                            <i class="bi bi-grip-vertical"></i>
                                                        </div>
                                                        <div class="p-2 rounded-3 me-3 lecture-order-badge" style="background: linear-gradient(135deg, #3b82f6, #2563eb); min-width: 48px; display: flex; align-items: center; justify-content: center;">
                                                            <span class="text-white fw-bold">{{ lecture.viewOrder }}</span>
                                                        </div>
                                                        <div class="flex-grow-1">
                                                            <h6 class="text-white mb-1">{{ lecture.name }}</h6>
                                                            {% if lecture.description %}
                                                                <small class="text-secondary d-block mb-2">{{ lecture.description|length > 80 ? lecture.description|slice(0, 80) ~ '...' : lecture.description }}</small>
                                                            {% endif %}
                                                            <div class="d-flex gap-2 flex-wrap align-items-center">
                                                                {% if lecture.lengthSeconds > 0 %}
                                                                    <span class="real-time-badge">
                                                                        <i class="bi bi-clock me-1"></i>{{ lecture.lengthFormatted }}
                                                                    </span>
                                                                {% endif %}

                                                                {# Processing Status with Real-time Updates #}
                                                                <div {% if lecture.processingStatus in ['processing', 'pending'] %}
                                                                         data-controller="lecture-processing"
                                                                         data-lecture-processing-course-id-value="{{ course.id }}"
                                                                         data-lecture-processing-lecture-id-value="{{ lecture.id }}"
                                                                         data-lecture-processing-status-url-value="{{ path('course_lecture_processing_status', {courseId: course.id, lectureId: lecture.id}) }}"
                                                                     {% endif %}
                                                                     class="d-flex gap-2 align-items-center flex-wrap">

                                                                    {# Status Badge #}
                                                                    <span data-lecture-processing-target="status" class="badge {% if lecture.processingStatus == 'completed' %}bg-success{% elseif lecture.processingStatus == 'processing' %}bg-warning text-dark{% elseif lecture.processingStatus == 'failed' %}bg-danger{% else %}bg-secondary{% endif %}">
                                                                        {% if lecture.processingStatus == 'completed' %}
                                                                            <i class="bi bi-check-circle me-1"></i>{{ ('course.lecture.status.completed')|trans }}
                                                                        {% elseif lecture.processingStatus == 'processing' %}
                                                                            <i class="bi bi-hourglass-split me-1"></i>{{ ('course.lecture.status.processing')|trans }}
                                                                        {% elseif lecture.processingStatus == 'failed' %}
                                                                            <i class="bi bi-exclamation-triangle me-1"></i>{{ ('course.lecture.status.failed')|trans }}
                                                                        {% else %}
                                                                            <i class="bi bi-clock-history me-1"></i>{{ ('course.lecture.status.pending')|trans }}
                                                                        {% endif %}
                                                                    </span>

                                                                    {# Watch Button (only if completed) #}
                                                                    <a href="{{ path('course_lecture_watch', {courseId: course.id, lectureId: lecture.id}) }}"
                                                                       data-lecture-processing-target="watchButton"
                                                                       class="real-time-badge"
                                                                       style="text-decoration: none; {{ lecture.processingStatus != 'completed' ? 'display: none;' : '' }}">
                                                                        <i class="bi bi-play-circle me-1"></i>{{ 'course.lecture.watch.video'|trans }}
                                                                    </a>

                                                                    {# Progress Bar (only if processing or pending) #}
                                                                    {% if lecture.processingStatus in ['processing', 'pending'] %}
                                                                        <div style="width: 200px;">
                                                                            <div class="progress" style="height: 6px; background: rgba(255, 255, 255, 0.1);">
                                                                                <div data-lecture-processing-target="progressBar"
                                                                                     class="progress-bar bg-info progress-bar-striped progress-bar-animated"
                                                                                     role="progressbar"
                                                                                     style="width: {{ lecture.processingPercentage }}%"
                                                                                     aria-valuenow="{{ lecture.processingPercentage }}"
                                                                                     aria-valuemin="0"
                                                                                     aria-valuemax="100">
                                                                                </div>
                                                                            </div>
                                                                            <small class="text-muted d-flex justify-content-between mt-1">
                                                                                <span data-lecture-processing-target="step">{{ lecture.processingStep ?: 'misc.waiting'|trans }}</span>
                                                                                <span data-lecture-processing-target="percentage">{{ lecture.processingPercentage }}%</span>
                                                                            </small>
                                                                        </div>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="d-flex gap-1">
                                                            {% if is_granted('COURSE_EDIT', course) %}
                                                                <button type="button"
                                                                        class="btn btn-sm infinity-btn-ai"
                                                                        data-controller="modal-opener"
                                                                        data-modal-opener-url-value="{{ path('course_lecture_edit', {courseId: course.id, lectureId: lecture.id}) }}"
                                                                        data-action="click->modal-opener#open"
                                                                        data-bs-toggle="tooltip"
                                                                        data-bs-title="{{ 'button.edit'|trans }}">
                                                                    <i class="bi bi-pencil"></i>
                                                                </button>
                                                            {% endif %}
                                                            {% if is_granted('COURSE_DELETE', course) %}
                                                                <button type="button"
                                                                        class="btn btn-sm infinity-btn-danger"
                                                                        data-delete-url="{{ path('course_lecture_delete', {courseId: course.id, lectureId: lecture.id}) }}"
                                                                        data-entity-name="{{ lecture.name }}"
                                                                        data-csrf-token="{{ csrf_token('delete-lecture-' ~ lecture.id) }}"
                                                                        data-bs-toggle="tooltip"
                                                                        data-bs-title="{{ 'button.delete'|trans }}">
                                                                    <i class="bi bi-trash"></i>
                                                                </button>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Enrolled Students Section (ADMIN and ORGANIZATION_ADMIN) -->
    {% if is_granted('COURSE_MANAGE_ENROLLMENTS', course) %}
    <div class="bento-item large">
        <div class="infinity-card p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="text-neon mb-0">
                    <i class="bi bi-people me-2"></i>{{ 'course.enrolled.students'|trans }} ({{ course.studentCourses|length }})
                </h5>
                <button type="button"
                        class="btn infinity-btn-primary btn-sm"
                        data-bs-toggle="modal"
                        data-bs-target="#enrollStudentModal"
                        data-bs-toggle="tooltip"
                        data-bs-title="{{ 'course.enroll.student'|trans }}">
                    <i class="bi bi-person-plus"></i>
                </button>
            </div>

            {% if course.studentCourses is empty %}
                <div class="text-center py-5">
                    <i class="bi bi-people" style="font-size: 3rem; color: var(--infinity-text-muted);"></i>
                    <h5 class="text-white mt-3 mb-2">{{ 'empty.no.students.enrolled'|trans }}</h5>
                    <p class="text-secondary mb-4">{{ 'empty.course.enrollment.description'|trans }}</p>
                    <button type="button"
                            class="btn infinity-btn-primary"
                            data-bs-toggle="modal"
                            data-bs-target="#enrollStudentModal">
                        <i class="bi bi-person-plus me-2"></i>{{ 'course.enroll.first.student'|trans }}
                    </button>
                </div>
            {% else %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle infinity-table">
                        <thead>
                            <tr>
                                <th><i class="bi bi-person me-2"></i>{{ 'user.name'|trans }}</th>
                                <th><i class="bi bi-envelope me-2"></i>{{ 'user.email'|trans }}</th>
                                <th><i class="bi bi-calendar me-2"></i>{{ 'course.enrolled.at'|trans }}</th>
                                <th><i class="bi bi-graph-up me-2"></i>{{ 'course.progress'|trans }}</th>
                                <th><i class="bi bi-toggle-on me-2"></i>{{ 'course.status'|trans }}</th>
                                <th class="text-end">{{ 'common.label.actions'|trans }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for enrollment in course.studentCourses %}
                            <tr>
                                <td class="text-white fw-bold">{{ enrollment.student.name }}</td>
                                <td class="text-secondary">{{ enrollment.student.email }}</td>
                                <td class="text-secondary">{{ enrollment.enrolledAt|date('M d, Y') }}</td>
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="progress" style="height: 8px; width: 120px; background: rgba(255, 255, 255, 0.1);">
                                            <div class="progress-bar"
                                                 role="progressbar"
                                                 style="width: {{ enrollment.progressPercentage }}%; background: linear-gradient(90deg, #10b981, #34d399);"
                                                 aria-valuenow="{{ enrollment.progressPercentage }}"
                                                 aria-valuemin="0"
                                                 aria-valuemax="100">
                                            </div>
                                        </div>
                                        <small class="text-secondary" style="min-width: 35px;">{{ enrollment.progressPercentage|round }}%</small>
                                    </div>
                                </td>
                                <td>
                                    {% if enrollment.active %}
                                        <span class="badge" style="background: rgba(16, 185, 129, 0.2); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.3); padding: 0.4rem 0.75rem;">
                                            <i class="bi bi-check-circle me-1"></i>{{ 'common.status.active'|trans }}
                                        </span>
                                    {% else %}
                                        <span class="badge" style="background: rgba(107, 114, 128, 0.2); color: #9ca3af; border: 1px solid rgba(107, 114, 128, 0.3); padding: 0.4rem 0.75rem;">
                                            <i class="bi bi-x-circle me-1"></i>{{ 'common.status.inactive'|trans }}
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <div class="d-inline-flex gap-1">
                                        <form method="post"
                                              action="{{ path('course_enrollment_toggle', {courseId: course.id, enrollmentId: enrollment.id}) }}">
                                            <input type="hidden" name="_token" value="{{ csrf_token('toggle-enrollment-' ~ enrollment.id) }}">
                                            <button type="submit"
                                                    class="btn btn-sm {{ enrollment.active ? 'infinity-btn-warning' : 'infinity-btn-success' }}"
                                                    data-bs-toggle="tooltip"
                                                    data-bs-title="{{ enrollment.active ? 'course.enrollment.deactivate'|trans : 'course.enrollment.activate'|trans }}"
                                                    style="min-width: 32px;">
                                                <i class="bi bi-{{ enrollment.active ? 'pause-circle' : 'play-circle' }}"></i>
                                            </button>
                                        </form>
                                        <form method="post"
                                              action="{{ path('course_enrollment_remove', {courseId: course.id, enrollmentId: enrollment.id}) }}"
                                              onsubmit="return confirm('{{ 'course.enrollment.confirm.remove'|trans({'%student%': enrollment.student.name}) }}');">
                                            <input type="hidden" name="_token" value="{{ csrf_token('remove-enrollment-' ~ enrollment.id) }}">
                                            <button type="submit"
                                                    class="btn btn-sm infinity-btn-danger"
                                                    data-bs-toggle="tooltip"
                                                    data-bs-title="{{ 'button.remove'|trans }}"
                                                    style="min-width: 32px;">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Enroll Student Modal (ADMIN and ORGANIZATION_ADMIN) -->
{% if is_granted('COURSE_MANAGE_ENROLLMENTS', course) %}
<div class="modal fade" id="enrollStudentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content" style="background: var(--infinity-card-bg); border: 1px solid var(--infinity-border-color);"
             data-controller="enrollment-switch"
             data-enrollment-switch-course-id-value="{{ course.id }}"
             data-enrollment-switch-enroll-url-value="{{ path('course_enrollment_add_multi', {courseId: course.id}) }}"
             data-enrollment-switch-deactivate-url-value="{{ path('course_enrollment_deactivate_multi', {courseId: course.id}) }}"
             data-enrollment-switch-saving-text-value="{{ 'button.saving'|trans }}"
             data-enrollment-switch-confirm-text-value="{{ 'button.confirm'|trans }}"
             data-enrollment-switch-enrolled-text-value="{{ 'course.enrollment.enrolled'|trans }}"
             data-enrollment-switch-deactivated-text-value="{{ 'course.enrollment.deactivate'|trans }}"
             data-enrollment-switch-no-changes-text-value="{{ 'modal.crud.unsaved_changes'|trans }}"
             data-enrollment-switch-error-text-value="{{ 'modal.crud.error_saving'|trans }}">
            <div class="modal-header" style="border-bottom: 1px solid var(--infinity-border-color);">
                <h5 class="modal-title text-white">
                    <i class="bi bi-people me-2"></i>{{ 'course.manage.enrollments'|trans }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <!-- Search Bar -->
                <div class="p-3 sticky-top" style="background: var(--infinity-card-bg); border-bottom: 1px solid var(--infinity-border-color); z-index: 10;">
                    <div class="input-group">
                        <span class="input-group-text" style="background: var(--infinity-bg); border-color: var(--infinity-border-color);">
                            <i class="bi bi-search text-white"></i>
                        </span>
                        <input type="text"
                               class="form-control"
                               placeholder="{{ 'course.enrollment.search.by.name'|trans }}"
                               data-enrollment-switch-target="searchInput"
                               data-action="input->enrollment-switch#search"
                               style="background: var(--infinity-bg); border-color: var(--infinity-border-color); color: white;">
                    </div>
                    <small class="text-muted d-block mt-2">
                        <i class="bi bi-info-circle me-1"></i>{{ 'course.enrollment.switch.hint'|trans }}
                    </small>
                </div>

                <!-- User List with Switches -->
                <div class="list-group list-group-flush" style="max-height: 400px; overflow-y: auto;">
                    {% set enrolledUserIds = course.studentCourses|filter(sc => sc.active)|map(sc => sc.student.id.toString) %}
                    {% for user in availableUsers %}
                    <div class="list-group-item d-flex justify-content-between align-items-center py-3"
                         style="background: var(--infinity-card-bg); border-color: var(--infinity-border-color);"
                         data-enrollment-switch-target="userRow"
                         data-user-name="{{ user.name }}">
                        <div class="d-flex align-items-center flex-grow-1">
                            <div class="me-3">
                                <div class="rounded-circle d-flex align-items-center justify-content-center"
                                     style="width: 40px; height: 40px; background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                                    <i class="bi bi-person-fill text-white"></i>
                                </div>
                            </div>
                            <div>
                                <h6 class="mb-0 text-white" data-enrollment-switch-target="userName">{{ user.name }}</h6>
                                <small class="text-muted">{{ user.email }}</small>
                            </div>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <span class="badge bg-success badge-enrolled" style="display: {{ user.id.toString in enrolledUserIds ? 'inline-block' : 'none' }}; min-width: 110px;" data-enrollment-switch-target="badgeEnrolled">
                                {{ 'course.enrollment.enrolled'|trans }}
                            </span>
                            <span class="badge bg-secondary badge-not-enrolled" style="display: {{ user.id.toString in enrolledUserIds ? 'none' : 'inline-block' }}; min-width: 110px;" data-enrollment-switch-target="badgeNotEnrolled">
                                {{ 'course.enrollment.not_enrolled'|trans }}
                            </span>
                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input"
                                       type="checkbox"
                                       role="switch"
                                       id="switch-{{ user.id }}"
                                       data-enrollment-switch-target="userSwitch"
                                       data-user-id="{{ user.id }}"
                                       {{ user.id.toString in enrolledUserIds ? 'checked' : '' }}
                                       style="width: 3rem; height: 1.5rem; cursor: pointer;">
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid var(--infinity-border-color);">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    {{ 'button.cancel'|trans }}
                </button>
                <button type="button"
                        class="btn infinity-btn-primary"
                        data-enrollment-switch-target="confirmButton"
                        data-action="click->enrollment-switch#confirm">
                    <i class="bi bi-check-circle me-2"></i>{{ 'button.confirm'|trans }}
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<style>
/* Module Accordion Styles */
.accordion-button {
    transition: all 0.2s ease;
}

.accordion-button:not(.collapsed) {
    background: var(--infinity-card-bg);
    color: white;
    box-shadow: none;
}

.accordion-button::after {
    filter: brightness(0) invert(1);
}

.accordion-button:focus {
    box-shadow: none;
    border-color: var(--infinity-border-color);
}

/* Lecture Card Styles */
.lecture-card {
    transition: all 0.2s ease;
    position: relative;
}

.lecture-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
}

/* Danger button matching infinity-btn-ai style */
.infinity-btn-danger {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.15));
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: #ef4444;
    font-weight: 500;
    transition: all 0.2s;
    width: 32px;
    height: 32px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0;
}

.infinity-btn-danger:hover {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.25), rgba(220, 38, 38, 0.25));
    border-color: rgba(239, 68, 68, 0.5);
    color: #ef4444;
    transform: translateY(-1px);
}

/* Ensure edit button has same fixed size */
.lecture-card .infinity-btn-ai,
.accordion-button .infinity-btn-ai {
    width: 32px;
    height: 32px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0;
}

/* Drag and Drop Styles */
.lecture-card-wrapper {
    transition: all 0.3s ease;
    position: relative;
    margin-bottom: 1rem;
}

.lecture-card-wrapper[draggable="true"] {
    cursor: grab !important;
}

.lecture-card-wrapper[draggable="true"]:active {
    cursor: grabbing !important;
}

/* When dragging, make card semi-transparent */
.lecture-card-wrapper[style*="opacity: 0.4"] {
    transform: scale(0.98);
}

.lecture-card-wrapper.drag-over-top {
    position: relative;
}

.lecture-card-wrapper.drag-over-top::before {
    content: '';
    position: absolute;
    top: -8px;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--infinity-neon, #00f5ff);
    border-radius: 2px;
    box-shadow: 0 0 12px rgba(0, 245, 255, 0.6);
    z-index: 10;
    animation: pulseGlow 0.8s ease-in-out infinite;
}

.lecture-card-wrapper.drag-over-bottom {
    position: relative;
}

.lecture-card-wrapper.drag-over-bottom::after {
    content: '';
    position: absolute;
    bottom: -8px;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--infinity-neon, #00f5ff);
    border-radius: 2px;
    box-shadow: 0 0 12px rgba(0, 245, 255, 0.6);
    z-index: 10;
    animation: pulseGlow 0.8s ease-in-out infinite;
}

@keyframes pulseGlow {
    0%, 100% {
        opacity: 1;
        box-shadow: 0 0 12px rgba(0, 245, 255, 0.6);
    }
    50% {
        opacity: 0.7;
        box-shadow: 0 0 20px rgba(0, 245, 255, 0.9);
    }
}

.lectures-drop-zone.drag-over {
    background: rgba(0, 245, 255, 0.08) !important;
    border: 2px dashed var(--infinity-neon, #00f5ff);
    border-radius: 8px;
}

/* Lecture Reorder Indicators */
.lecture-reorder-indicator {
    padding: 0.75rem 1rem;
    margin-bottom: 1rem;
    border-radius: 8px;
    display: flex;
    align-items: center;
    font-weight: 500;
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.lecture-reorder-indicator.saving {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(37, 99, 235, 0.15));
    border: 1px solid rgba(59, 130, 246, 0.3);
    color: #3b82f6;
}

.lecture-reorder-indicator.success {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(22, 163, 74, 0.15));
    border: 1px solid rgba(34, 197, 94, 0.3);
    color: #22c55e;
}

.lecture-reorder-indicator.error {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.15));
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: #ef4444;
}

.lecture-reorder-indicator .spin {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* Drag Handle */
.lecture-drag-handle {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 100%;
    min-height: 48px;
    color: var(--infinity-text-muted, rgba(255, 255, 255, 0.3));
    cursor: grab;
    transition: all 0.2s ease;
    border-radius: 6px;
    font-size: 1.25rem;
}

.lecture-drag-handle:hover {
    color: var(--infinity-neon, #00f5ff);
    background: rgba(0, 245, 255, 0.1);
}

.lecture-card-wrapper[draggable="true"]:active .lecture-drag-handle {
    cursor: grabbing;
    color: var(--infinity-neon, #00f5ff);
    background: rgba(0, 245, 255, 0.15);
}

/* Module Drag and Drop */
.module-drag-handle {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 100%;
    min-height: 60px;
    color: var(--infinity-text-muted, rgba(255, 255, 255, 0.3));
    cursor: grab;
    transition: all 0.2s ease;
    border-radius: 6px;
    font-size: 1.5rem;
    padding: 0.5rem;
}

.module-drag-handle:hover {
    color: var(--infinity-neon, #00f5ff);
    background: rgba(0, 245, 255, 0.1);
}

.module-wrapper[draggable="true"]:active .module-drag-handle {
    cursor: grabbing;
    color: var(--infinity-neon, #00f5ff);
    background: rgba(0, 245, 255, 0.15);
}

.module-wrapper.drag-over-top::before {
    content: '';
    position: absolute;
    top: -8px;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--infinity-neon, #00f5ff);
    border-radius: 2px;
    box-shadow: 0 0 12px rgba(0, 245, 255, 0.6);
    z-index: 10;
    animation: pulseGlow 0.8s ease-in-out infinite;
}

.module-wrapper.drag-over-bottom::after {
    content: '';
    position: absolute;
    bottom: -8px;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--infinity-neon, #00f5ff);
    border-radius: 2px;
    box-shadow: 0 0 12px rgba(0, 245, 255, 0.6);
    z-index: 10;
    animation: pulseGlow 0.8s ease-in-out infinite;
}

.module-wrapper {
    position: relative;
    transition: all 0.2s ease;
}

/* Module Reorder Indicators */
.module-reorder-indicator {
    padding: 12px 20px;
    border-radius: 6px;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    font-weight: 500;
    animation: slideInDown 0.3s ease-out;
}

.module-reorder-indicator.saving {
    background: rgba(59, 130, 246, 0.15);
    border: 1px solid rgba(59, 130, 246, 0.3);
    color: #60a5fa;
}

.module-reorder-indicator.success {
    background: rgba(16, 185, 129, 0.15);
    border: 1px solid rgba(16, 185, 129, 0.3);
    color: #34d399;
}

.module-reorder-indicator.error {
    background: rgba(239, 68, 68, 0.15);
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: #f87171;
}

/* Students Table Styling */
.infinity-table {
    margin-bottom: 0;
}

.infinity-table thead tr {
    border-bottom: 2px solid var(--infinity-border-color);
}

.infinity-table thead th {
    color: var(--infinity-text-white);
    font-weight: 600;
    padding: 1rem 0.75rem;
    border: none;
    background: transparent;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.5px;
}

.infinity-table tbody tr {
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    transition: all 0.2s ease;
}

.infinity-table tbody tr:hover {
    background: rgba(0, 245, 255, 0.03);
}

.infinity-table tbody tr:last-child {
    border-bottom: none;
}

.infinity-table tbody td {
    padding: 1rem 0.75rem;
    border: none;
    vertical-align: middle;
}

/* Additional Button Styles */
.infinity-btn-warning {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-weight: 500;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(245, 158, 11, 0.2);
}

.infinity-btn-warning:hover {
    background: linear-gradient(135deg, #d97706, #b45309);
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
    transform: translateY(-1px);
    color: white;
}

.infinity-btn-success {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-weight: 500;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
}

.infinity-btn-success:hover {
    background: linear-gradient(135deg, #059669, #047857);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    transform: translateY(-1px);
    color: white;
}
</style>
{% endblock %}
