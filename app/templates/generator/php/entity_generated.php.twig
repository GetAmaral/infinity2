<?php

declare(strict_types=1);

namespace {{ namespace }};

use App\Entity\EntityBase;
{% if usesOrganizationTrait %}
use App\Entity\Trait\OrganizationTrait;
{% endif %}
use Doctrine\ORM\Mapping as ORM;
{% if entity.properties|filter(p => p.isCollection())|length > 0 %}
use Doctrine\Common\Collections\ArrayCollection;
use Doctrine\Common\Collections\Collection;
{% endif %}
use Symfony\Component\Validator\Constraints as Assert;
use Symfony\Component\Serializer\Annotation\Groups;
{% set relationshipProperties = entity.properties|filter(p => p.isRelationship() and (not usesOrganizationTrait or p.propertyName != 'organization')) %}
{% set targetEntities = [] %}
{% for property in relationshipProperties %}
    {% if property.targetEntity and property.targetEntity|length > 0 and property.targetEntity not in targetEntities %}
        {% set targetEntities = targetEntities|merge([property.targetEntity]) %}
    {% endif %}
{% endfor %}
{% for targetEntity in targetEntities %}
use App\Entity\{{ targetEntity }};
{% endfor %}

/**
 * {{ entity.entityLabel }} Entity (Generated Base Class)
 *
 * {{ entity.description }}
 *
 * This class is ALWAYS regenerated from CSV. DO NOT edit this file.
 * Add custom logic to {{ entity.entityName }}.php instead.
 *
 * @generated by Luminai Code Generator
 * @see /config/EntityNew.csv and /config/PropertyNew.csv
 */
#[ORM\MappedSuperclass]
#[ORM\HasLifecycleCallbacks]
{% set indexedScalarProperties = entity.properties|filter(p => p.indexed and not p.isRelationship()) %}
{% for property in indexedScalarProperties %}
{% if property.indexType == 'simple' %}
#[ORM\Index(columns: ['{{ property.propertyName }}'])]
{% elseif property.indexType == 'composite' and property.compositeIndexWith %}
#[ORM\Index(columns: ['{{ property.propertyName }}'{% if property.compositeIndexWith is iterable %}{% for col in property.compositeIndexWith %}, '{{ col }}'{% endfor %}{% else %}, '{{ property.compositeIndexWith }}'{% endif %}])]
{% elseif property.indexType == 'unique' %}
{# Unique constraint already handled by unique column property #}
{% endif %}
{% endfor %}
{% set indexedRelationships = entity.properties|filter(p => p.indexed and p.isSingleRelationship()) %}
{% for property in indexedRelationships %}
{% if property.indexType == 'simple' %}
#[ORM\Index(columns: ['{{ property.propertyName }}_id'])]
{% elseif property.indexType == 'composite' and property.compositeIndexWith %}
#[ORM\Index(columns: ['{{ property.propertyName }}_id'{% if property.compositeIndexWith is iterable %}{% for col in property.compositeIndexWith %}, '{{ col }}'{% endfor %}{% else %}, '{{ property.compositeIndexWith }}'{% endif %}])]
{% endif %}
{% endfor %}
abstract class {{ className }} extends {{ extendsClass }}
{
{% if usesOrganizationTrait %}
    use OrganizationTrait;

{% endif %}
{% for property in entity.properties %}
{% if usesOrganizationTrait and property.propertyName == 'organization' %}
{# Skip organization property - provided by OrganizationTrait #}
{% elseif not property.isRelationship() %}
    #[ORM\Column(type: '{{ property.propertyType }}'{% if property.length %}, length: {{ property.length }}{% endif %}{% if property.precision %}, precision: {{ property.precision }}{% endif %}{% if property.scale %}, scale: {{ property.scale }}{% endif %}{% if property.nullable %}, nullable: true{% endif %}{% if property.unique %}, unique: true{% endif %})]
{% for rule in property.validationRules %}
    #[Assert\{{ rule|replace({'=': ': '}) }}]
{% endfor %}
{% if property.apiGroups|length > 0 %}
    #[Groups([{% for group in property.apiGroups %}'{{ group }}'{% if not loop.last %}, {% endif %}{% endfor %}])]
{% endif %}
    protected {% if property.nullable %}?{% endif %}{{ property.getPhpType() }} ${{ property.propertyName }}{% if property.defaultValue %} = {{ property.defaultValue }}{% elseif property.nullable %} = null{% endif %};

{% else %}
{# Relationship properties #}
{% if property.isCollection() %}
    #[ORM\{{ property.relationshipType }}(targetEntity: {{ property.targetEntity }}::class{% if property.relationshipType == 'OneToMany' %}{% if property.mappedBy %}, mappedBy: '{{ property.mappedBy }}'{% elseif property.inversedBy %}, mappedBy: '{{ property.inversedBy }}'{% endif %}{% else %}{% if property.mappedBy %}, mappedBy: '{{ property.mappedBy }}'{% endif %}{% if property.inversedBy %}, inversedBy: '{{ property.inversedBy }}'{% endif %}{% endif %}{% if property.cascade|length > 0 %}, cascade: [{% for op in property.cascade %}'{{ op }}'{% if not loop.last %}, {% endif %}{% endfor %}]{% endif %}{% if property.orphanRemoval %}, orphanRemoval: true{% endif %}{% if property.fetch %}, fetch: '{{ property.fetch }}'{% endif %})]
{% if property.orderBy|length > 0 %}
    #[ORM\OrderBy([{% for field, direction in property.orderBy %}'{{ field }}' => '{{ direction|upper }}'{% if not loop.last %}, {% endif %}{% endfor %}])]
{% endif %}
{% if property.apiGroups|length > 0 %}
    #[Groups([{% for group in property.apiGroups %}'{{ group }}'{% if not loop.last %}, {% endif %}{% endfor %}])]
{% endif %}
    protected Collection ${{ property.propertyName }};

{% else %}
{# ManyToOne or OneToOne #}
    #[ORM\{{ property.relationshipType }}(targetEntity: {{ property.targetEntity }}::class{% if property.inversedBy %}, inversedBy: '{{ property.inversedBy }}'{% endif %})]
{% if not property.nullable %}
    #[ORM\JoinColumn(nullable: false)]
{% endif %}
{% if property.apiGroups|length > 0 %}
    #[Groups([{% for group in property.apiGroups %}'{{ group }}'{% if not loop.last %}, {% endif %}{% endfor %}])]
{% endif %}
    protected {% if property.nullable %}?{% endif %}{{ property.targetEntity }} ${{ property.propertyName }}{% if property.nullable %} = null{% endif %};

{% endif %}
{% endif %}
{% endfor %}

    public function __construct()
    {
        parent::__construct();
{% for property in entity.properties %}
{% if property.isCollection() %}
        $this->{{ property.propertyName }} = new ArrayCollection();
{% endif %}
{% endfor %}
    }

{% for property in entity.properties %}
{% if usesOrganizationTrait and property.propertyName == 'organization' %}
{# Skip organization methods - provided by OrganizationTrait #}
{% elseif not property.isRelationship() %}
    public function get{{ property.propertyName|capitalize }}(): {% if property.nullable %}?{% endif %}{{ property.getPhpType() }}
    {
        return $this->{{ property.propertyName }};
    }

    public function set{{ property.propertyName|capitalize }}({% if property.nullable %}?{% endif %}{{ property.getPhpType() }} ${{ property.propertyName }}): self
    {
        $this->{{ property.propertyName }} = ${{ property.propertyName }};
        return $this;
    }

    {% if property.isBool() %}
    public function is{{ property.propertyName|capitalize }}(): boolean
    {
        return $this->{{ property.propertyName }} === true;
    }
    {% endif %}

{% else %}
{% if property.isCollection() %}
    /**
     * @return Collection<int, {{ property.targetEntity }}>
     */
    public function get{{ property.propertyName|capitalize }}(): Collection
    {
        return $this->{{ property.propertyName }};
    }

    public function add{{ property.propertyName|capitalize|slice(0, -1) }}({{ property.targetEntity }} ${{ property.propertyName|slice(0, -1) }}): self
    {
        if (!$this->{{ property.propertyName }}->contains(${{ property.propertyName|slice(0, -1) }})) {
            $this->{{ property.propertyName }}->add(${{ property.propertyName|slice(0, -1) }});
{% if property.mappedBy %}
            ${{ property.propertyName|slice(0, -1) }}->set{{ property.mappedBy|capitalize }}($this);
{% endif %}
        }
        return $this;
    }

    public function remove{{ property.propertyName|capitalize|slice(0, -1) }}({{ property.targetEntity }} ${{ property.propertyName|slice(0, -1) }}): self
    {
        if ($this->{{ property.propertyName }}->removeElement(${{ property.propertyName|slice(0, -1) }})) {
{% if property.mappedBy %}
            if (${{ property.propertyName|slice(0, -1) }}->get{{ property.mappedBy|capitalize }}() === $this) {
                ${{ property.propertyName|slice(0, -1) }}->set{{ property.mappedBy|capitalize }}(null);
            }
{% endif %}
        }
        return $this;
    }

{% elseif usesOrganizationTrait and property.propertyName == 'organization' %}
{# Skip organization relationship methods - provided by OrganizationTrait #}
{% else %}
    public function get{{ property.propertyName|capitalize }}(): {% if property.nullable %}?{% endif %}{{ property.targetEntity }}
    {
        return $this->{{ property.propertyName }};
    }

    public function set{{ property.propertyName|capitalize }}({% if property.nullable %}?{% endif %}{{ property.targetEntity }} ${{ property.propertyName }}): self
    {
        $this->{{ property.propertyName }} = ${{ property.propertyName }};
        return $this;
    }

{% endif %}
{% endif %}
{% endfor %}

    public function __toString(): string
    {
{% set nameProperty = entity.properties|filter(p => p.propertyName == 'name')|first %}
{% if nameProperty %}
        return $this->name ?? '';
{% else %}
        return (string) $this->getId()->toRfc4122();
{% endif %}
    }
}
